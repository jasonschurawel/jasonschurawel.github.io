name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build with GitHub data
      run: |
        echo "ğŸ”§ Setting up Go dependencies..."
        cd server
        go mod tidy
        cd ..
        
        echo "ğŸ§¹ Cleaning up any existing processes..."
        pkill -f "go run main.go" || true
        sleep 2
        
        echo "ğŸ“¡ Starting Go server..."
        cd server
        timeout 30s go run main.go &
        GO_PID=$!
        cd ..
        
        echo "â³ Waiting for server to start..."
        sleep 8
        
        echo "ğŸ” Checking server health..."
        RETRIES=10
        while [ $RETRIES -gt 0 ]; do
          if curl -f -s http://localhost:8080/api/health > /dev/null; then
            echo "âœ… Go server is responding"
            break
          fi
          echo "â³ Waiting for server... ($RETRIES attempts left)"
          sleep 2
          RETRIES=$((RETRIES-1))
        done
        
        if [ $RETRIES -eq 0 ]; then
          echo "âŒ Server failed to start"
          kill $GO_PID 2>/dev/null || true
          exit 1
        fi
        
        echo "ğŸ“Š Fetching GitHub repositories..."
        mkdir -p public/api
        if curl -f -s http://localhost:8080/api/projects > public/api/projects.json; then
          echo "âœ… GitHub data fetched successfully"
          # Verify JSON is valid and not empty
          if [ -s public/api/projects.json ]; then
            echo "âœ… JSON file created successfully"
            head -c 200 public/api/projects.json  # Show first 200 chars for debugging
          else
            echo "âŒ JSON file is empty"
            kill $GO_PID 2>/dev/null || true
            exit 1
          fi
        else
          echo "âŒ Failed to fetch GitHub data"
          kill $GO_PID 2>/dev/null || true
          exit 1
        fi
        
        echo "ğŸ›‘ Stopping Go server..."
        kill $GO_PID 2>/dev/null || true
        sleep 2
        
        echo "ğŸ”„ Building React application..."
        npm run build
        
        echo "ğŸ“‹ Copying GitHub data to build output..."
        mkdir -p dist/api
        cp public/api/projects.json dist/api/
        
        echo "ğŸ“ Checking build output..."
        if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
          echo "âœ… Build successful - dist directory contains files"
          ls -la dist/
          echo "ğŸ“Š API data:"
          ls -la dist/api/
        else
          echo "âŒ Build failed - dist directory is missing or empty"
          exit 1
        fi
      
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
